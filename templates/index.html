<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Translator - Liquid Glass</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-primary: #374151;
            --text-secondary: #6b7280;
            --dark-glass: rgba(17, 24, 39, 0.9);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            background: 
                radial-gradient(circle at 10% 20%, rgb(239, 246, 255) 0%, rgba(255,255,255,0) 50%),
                radial-gradient(circle at 90% 80%, rgb(243, 244, 246) 0%, rgba(255,255,255,0) 50%),
                #f8fafc;
            overflow-x: hidden;
        }

        body::before, body::after {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            z-index: -1;
            filter: blur(90px);
            opacity: 0.5;
        }
        body::before { background: #e0e7ff; top: -150px; left: -100px; }
        body::after { background: #f3f4f6; top: 100px; right: -150px; }

        .app-header {
            width: 100%;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.4); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.5);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-area h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4b5563;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-area h1 span { font-weight: 300; color: var(--text-secondary); }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            z-index: 1;
        }

        .translate-box {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .language-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            background: rgba(255,255,255,0.3);
        }

        .language-group { flex: 1; position: relative; }

        .language-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .language-btn:hover { background: rgba(0,0,0,0.05); color: #000; }

        .swap-container { flex: 0 0 50px; display: flex; justify-content: center; }
        .swap-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.05);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            color: var(--text-secondary);
        }
        .swap-button:hover { background: #f3f4f6; transform: rotate(180deg); color: var(--text-primary); }

        .dropdown-menu {
            position: absolute;
            top: 100%; left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 10px;
            min-width: 250px;
            z-index: 50;
            display: none;
            animation: slideDown 0.2s cubic-bezier(0.2, 0, 0.2, 1);
        }
        .dropdown-menu.active { display: block; }
        
        .search-box input {
            width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; font-size: 14px;
        }
        .language-list { max-height: 300px; overflow-y: auto; list-style: none; }
        .language-item { padding: 10px 12px; cursor: pointer; border-radius: 6px; font-size: 14px; color: var(--text-primary); }
        .language-item:hover { background: #f3f4f6; }
        .language-item.selected { color: #2563eb; background: #eff6ff; font-weight: 500; }

        .text-areas { display: grid; grid-template-columns: 1fr 1fr; min-height: 300px; }
        .text-area { position: relative; padding: 24px; display: flex; flex-direction: column; }
        .text-area.input { border-right: 1px solid rgba(0,0,0,0.04); }
        .text-area.output { background: rgba(249, 250, 251, 0.5); }

        textarea {
            width: 100%; flex: 1; border: none; background: transparent; font-size: 22px; line-height: 1.5; font-family: inherit; resize: none; color: #1f2937; font-weight: 400;
        }
        textarea::placeholder { color: #9ca3af; font-weight: 300; }

        .char-count { position: absolute; bottom: 16px; right: 24px; font-size: 12px; color: #9ca3af; }

        .action-bar {
            padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(0,0,0,0.04); background: rgba(255,255,255,0.4);
        }
        .tools-left { display: flex; gap: 12px; align-items: center; }
        .tools-right { display: flex; gap: 16px; align-items: center; }

        /* Icon Button Generic */
        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid transparent; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); font-size: 18px; color: var(--text-secondary);
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-primary); }

        /* --- NEW: Feedback Hover Group --- */
        .feedback-container {
            position: relative;
            display: inline-block;
        }

        /* N√∫t trigger ph·∫£n h·ªìi */
        .feedback-trigger {
            transition: all 0.3s ease;
        }
        /* Popup ch·ª©a n√∫t Like/Dislike */
        .feedback-popup {
            position: absolute;
            bottom: 110%; /* Hi·ªán ph√≠a tr√™n n√∫t */
            right: 0;
            display: flex;
            gap: 8px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px);
            padding: 6px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Khi hover v√†o container, popup hi·ªán l√™n */
        .feedback-container:hover .feedback-popup {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* Hi·ªáu ·ª©ng Visual Feedback khi Active */
        .icon-btn.active-like {
            background-color: #dcfce7 !important;
            color: #166534 !important;
            border-color: #bbf7d0 !important;
        }
        .icon-btn.active-dislike {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
            border-color: #fecaca !important;
        }
        /* --- END NEW --- */

        .upload-label {
            display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 50px; font-size: 14px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: var(--transition);
        }
        .upload-label:hover { border-color: #d1d5db; color: var(--text-primary); }

        .translate-btn {
            padding: 12px 32px; background: var(--dark-glass); color: white; border: none; border-radius: 50px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: var(--transition);
        }
        .translate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }

        #styleSelect { border: none; background: transparent; font-size: 14px; font-weight: 500; color: var(--text-primary); cursor: pointer; padding: 5px; }

        .switch { position: relative; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--text-primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 10; border-radius: var(--radius-lg); font-weight: 500; }
        .loading-overlay.active { display: flex; }

        .error-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; pointer-events: none; transition: var(--transition); z-index: 1000; }
        .error-toast.active { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        @media (max-width: 768px) {
            .app-header { padding: 15px 20px; }
            .container { margin-top: 20px; padding: 0 10px; }
            .text-areas { grid-template-columns: 1fr; }
            .text-area.input { border-right: none; border-bottom: 1px solid rgba(0,0,0,0.04); min-height: 200px; }
            .language-selector { flex-wrap: wrap; gap: 10px; }
            .swap-container { transform: rotate(90deg); }
            .action-bar { flex-direction: column; gap: 20px; }
            .tools-left, .tools-right { width: 100%; justify-content: space-between; }
        }

        @keyframes slideDown { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)}}
    </style>
</head>
<body>
    <header class="app-header">
        <div class="logo-area">
            <h1>AI Translator <span>/ Glass</span></h1>
        </div>
    </header>

    <div class="container">
        <div class="translate-box">
            
            <div class="language-selector">
                <div class="language-group">
                    <button class="language-btn" id="sourceLangBtn">
                        <span id="sourceLangText">Vietnamese</span> ‚ñº
                    </button>
                    <div class="dropdown-menu" id="sourceDropdown">
                        <div class="search-box"><input type="text" id="sourceSearch" placeholder="T√¨m ki·∫øm..."></div>
                        <ul class="language-list" id="sourceList"></ul>
                    </div>
                </div>

                <div class="swap-container">
                    <button class="swap-button" id="swapBtn" title="Ho√°n ƒë·ªïi">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
                    </button>
                </div>

                <div class="language-group" style="text-align: right; display: flex; justify-content: flex-end;">
                    <button class="language-btn" id="targetLangBtn">
                        <span id="targetLangText">English</span> ‚ñº
                    </button>
                    <div class="dropdown-menu" id="targetDropdown">
                        <div class="search-box"><input type="text" id="targetSearch" placeholder="T√¨m ki·∫øm..."></div>
                        <ul class="language-list" id="targetList"></ul>
                    </div>
                </div>
            </div>

            <div class="text-areas">
                <div class="loading-overlay" id="loading">‚ú® ƒêang d·ªãch...</div>

                <div class="text-area input">
                    <textarea id="sourceText" placeholder="Nh·∫≠p vƒÉn b·∫£n..."></textarea>
                    <div class="char-count"><span id="charCount">0</span>/5000</div>
                </div>
                
                <div class="text-area output">
                    <textarea id="targetText" placeholder="B·∫£n d·ªãch" readonly></textarea>
                    
                    <div style="margin-top: auto; display: flex; gap: 8px; justify-content: flex-end; align-items: center;">
                        <button class="icon-btn" id="ttsBtn" title="Nghe">üîä</button>
                        
                        <div class="feedback-container">
                            <button class="icon-btn feedback-trigger" id="feedbackTrigger" title="Ph·∫£n h·ªìi">
                                üí¨
                            </button>
                            
                            <div class="feedback-popup">
                                <button class="icon-btn" id="likeBtn" title="Hay">üëç</button>
                                <button class="icon-btn" id="dislikeBtn" title="Ch∆∞a hay">üëé</button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <div class="tools-left">
                    <label class="upload-label">
                        üìÅ T·∫£i file
                        <input type="file" id="fileInput" accept=".txt,.doc,.docx,.pdf" hidden>
                    </label>
                    <span id="fileName" style="font-size: 13px; color: #6b7280;"></span>
                </div>

                <div class="tools-right">
                    <select id="styleSelect">
                         {% for s in styte_list %}
                            <option value="{{ s }}">{{ s }}</option>
                        {% endfor %}
                    </select>

                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 13px; font-weight: 500; color: #6b7280;">Deep Think</span>
                        <label class="switch">
                            <input type="checkbox" id="thinkingToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <button class="translate-btn" id="translateBtn">D·ªãch</button>
                </div>
            </div>
        </div>
    </div>

    <div class="error-toast" id="errorToast">L·ªói k·∫øt n·ªëi</div>

    <script>
        const languageCodeDict = {{ language_code_dict | tojson }};
        let sourceLanguage = 'Vietnamese';
        let targetLanguage = 'English';

        document.addEventListener('DOMContentLoaded', () => {
            initLanguageList();
            updateSelectedItems();
        });

        function initLanguageList() {
            const srcList = document.getElementById('sourceList');
            const tgtList = document.getElementById('targetList');
            srcList.innerHTML = ''; tgtList.innerHTML = '';

            Object.keys(languageCodeDict).forEach(lang => {
                const li = (type) => {
                    const el = document.createElement('li');
                    el.className = 'language-item';
                    el.textContent = lang;
                    el.onclick = () => type === 'src' ? setSource(lang) : setTarget(lang);
                    return el;
                };
                srcList.appendChild(li('src'));
                tgtList.appendChild(li('tgt'));
            });
        }

        function setSource(lang) {
            sourceLanguage = lang;
            document.getElementById('sourceLangText').textContent = lang;
            document.getElementById('sourceDropdown').classList.remove('active');
            updateSelectedItems();
        }
        function setTarget(lang) {
            targetLanguage = lang;
            document.getElementById('targetLangText').textContent = lang;
            document.getElementById('targetDropdown').classList.remove('active');
            updateSelectedItems();
        }
        function updateSelectedItems() {
            document.querySelectorAll('#sourceList .language-item').forEach(i => i.classList.toggle('selected', i.textContent === sourceLanguage));
            document.querySelectorAll('#targetList .language-item').forEach(i => i.classList.toggle('selected', i.textContent === targetLanguage));
        }

        const toggle = (id) => {
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if(m.id !== id) m.classList.remove('active');
            });
            document.getElementById(id).classList.toggle('active');
        };
        document.getElementById('sourceLangBtn').onclick = (e) => { e.stopPropagation(); toggle('sourceDropdown'); };
        document.getElementById('targetLangBtn').onclick = (e) => { e.stopPropagation(); toggle('targetDropdown'); };
        window.onclick = () => document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));

        const search = (inpId, listId) => {
            const v = document.getElementById(inpId).value.toLowerCase();
            document.querySelectorAll(`#${listId} li`).forEach(li => {
                li.style.display = li.textContent.toLowerCase().includes(v) ? 'block' : 'none';
            });
        };
        document.getElementById('sourceSearch').oninput = () => search('sourceSearch', 'sourceList');
        document.getElementById('targetSearch').oninput = () => search('targetSearch', 'targetList');

        document.getElementById('swapBtn').onclick = () => {
            [sourceLanguage, targetLanguage] = [targetLanguage, sourceLanguage];
            document.getElementById('sourceLangText').textContent = sourceLanguage;
            document.getElementById('targetLangText').textContent = targetLanguage;
            const s = document.getElementById('sourceText');
            const t = document.getElementById('targetText');
            [s.value, t.value] = [t.value, s.value];
            updateSelectedItems();
        };

        document.getElementById('sourceText').oninput = function() {
            if(this.value.length > 5000) this.value = this.value.substring(0,5000);
            document.getElementById('charCount').textContent = this.value.length;
        };

        function showToast(msg) {
            const t = document.getElementById('errorToast');
            t.textContent = msg;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        document.getElementById('translateBtn').onclick = async () => {
            const text = document.getElementById('sourceText').value.trim();
            if(!text) return;
            const loader = document.getElementById('loading');
            loader.classList.add('active');
            
            // Reset feedback button state when new translation starts
            const trigger = document.getElementById('feedbackTrigger');
            trigger.textContent = 'üí¨';
            trigger.className = 'icon-btn feedback-trigger';

            try {
                const res = await fetch('/translate', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        text, src_language: sourceLanguage, fr_language: targetLanguage,
                        style: document.getElementById('styleSelect').value,
                        thinking: document.getElementById('thinkingToggle').checked 
                    })
                });
                const data = await res.json();
                if(res.ok) document.getElementById('targetText').value = data.translation;
                else showToast(data.error || 'L·ªói d·ªãch thu·∫≠t');
            } catch(e) { showToast('L·ªói k·∫øt n·ªëi'); }
            finally { loader.classList.remove('active'); }
        };

        // --- UPDATED: Feedback Logic ---
        const sendFb = async (like) => {
            const s = document.getElementById('sourceText').value;
            const t = document.getElementById('targetText').value;
            if(!s || !t) return;
            
            // Update UI immediately (Visual Feedback)
            const trigger = document.getElementById('feedbackTrigger');
            trigger.className = 'icon-btn feedback-trigger'; // Reset classes
            
            if (like) {
                trigger.textContent = 'üëç';
                trigger.classList.add('active-like');
                showToast('ƒê√£ th√≠ch b·∫£n d·ªãch n√†y');
            } else {
                trigger.textContent = 'üëé';
                trigger.classList.add('active-dislike');
                showToast('ƒê√£ b√°o c√°o b·∫£n d·ªãch ch∆∞a t·ªët');
            }

            // Send to Server
            fetch('/feedback', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    src_language: sourceLanguage,
                    fr_language: targetLanguage,
                    text: s,
                    translation: t,
                    style: document.getElementById('styleSelect').value,
                    type: like ? 1 : 0
                })
            }).catch(() => showToast('Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi'));
        };
        
        document.getElementById('likeBtn').onclick = () => sendFb(true);
        document.getElementById('dislikeBtn').onclick = () => sendFb(false);
        // --- END UPDATED ---

        // Text-to-Speech
        document.getElementById('ttsBtn').onclick = async () => {
            const text = document.getElementById('targetText').value.trim();
            
            if (!text) {
                showToast('Ch∆∞a c√≥ b·∫£n d·ªãch ƒë·ªÉ chuy·ªÉn th√†nh gi·ªçng n√≥i!');
                return;
            }

            try {
                const speechLang = languageCodeDict[targetLanguage].split('_')[0];
                const response = await fetch('/speed2text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        translation: text,
                        fr_language: speechLang
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.media) {
                    const audio = new Audio(data.media);
                    audio.play().catch(err => {
                        console.error('Playback error:', err);
                        showToast('Kh√¥ng th·ªÉ ph√°t √¢m thanh!');
                    });
                } else {
                    showToast(data.error || 'Kh√¥ng th·ªÉ t·∫°o √¢m thanh!');
                }
            } catch (error) {
                showToast('L·ªói khi t·∫°o √¢m thanh!');
                console.error('TTS error:', error);
            }
        };

        document.getElementById('fileInput').onchange = async (e) => {
            const f = e.target.files[0];
            if(!f) return;
            document.getElementById('fileName').textContent = f.name;
            const fd = new FormData(); fd.append('file', f);
            try {
                const r = await fetch('/uploadfile', { method:'POST', body:fd });
                const d = await r.json();
                if(r.ok) showToast('ƒê√£ t·∫£i file: ' + d.filename);
                else showToast(d.error);
            } catch { showToast('L·ªói upload'); }
        };
    </script>
</body>
</html>